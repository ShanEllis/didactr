#' Update Youtube Link
#'
#' @param course_status output from \code{\link{check_course}}
#' @param youtube_uploads The `data.frame` output from
#' \code{\link{update_youtube}}.  Will look in the metric path if not
#' specified.
#' @return updated manuscript files
#' @export
#'
update_youtube_link <- function(
  course_status = NULL,
  youtube_uploads = NULL){
  df = course_status$course_summary
  paths = course_status$paths

  yt_file = file.path(paths$met_path ,"youtube_uploads.rds")
  if (file.exists(yt_file)) {
    youtube_uploads = readRDS(yt_file)
  } else {
    if (is.null(youtube_uploads)) {
      stop("YouTube uploads not found")
    }
  }
  sapply(df$lesson,
         function(x) {
           ## get vids for this lesson
           vids = youtube_uploads %>%
             mutate(les = sub("[.]mp4$", "", basename(file)) ) %>%
             filter(les == x) %>%
             arrange(desc(time_published))
           ## update if no link exists
           ## or if more recent upload has occurred
           if(is.na(df$yt_md_link[df$lesson == x]) | nrow(vids)>0 & vids$url[1] != df$yt_md_link[df$lesson == x]){
             message(paste0("updating youtube link in manuscript file: ", x))
             t  <- readLines(df$md_file[df$lesson == x])
             # identify which link to edit for the video
             line <- grep(pattern = "^!\\[.+\\]\\((?!\\.png)\\)|!\\[.+\\]\\(.+[^.png]\\)|^!\\[.+\\]\\(https\\:\\/\\/www\\.youtu.+\\)",t,perl=TRUE)
             t[line]<-gsub("\\(.+\\)|\\(\\)",paste0("(",vids$url[1],")"),t[line])
             writeLines(t, con=df$md_file[df$lesson == x])
           }
         })
  ret = check_course(course_dir = course_status$course_dir,
                     save_metrics = course_status$save_metrics)
  return(ret)
}
